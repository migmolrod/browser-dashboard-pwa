---
sidebar_position: 7.0
title: User identity
status: Draft
lastUpdated: 2025-11-15
---

import RequirementMetadata from "../../../src/components/RequirementMetadata";
// noinspection ES6UnusedImports
import PriorityLabel from "../../../src/components/PriorityLabel";
// noinspection ES6UnusedImports
import StatusLabel from "../../../src/components/StatusLabel";

<RequirementMetadata/>

# User identity

## Overview

The User Identity bounded context provides foundational user identification, authentication, and session management for
the Browser Dashboard PWA. It serves as the system-of-record for user identity and acts as the entry point for all user
interactions. The context handles user registration, login/logout, and basic session lifecycle management.

**Bounded context code:** UID\
**Related DMD section:** [User Identity (Generic)](../../domain/bounded-contexts/user-identity)

## Features

### Summary

| Feature Code | Feature Name            | Priority                                | Status                        |
|--------------|-------------------------|-----------------------------------------|-------------------------------|
| FR-UID-001   | User registration       | <PriorityLabel priority="Must Have"/>   | <StatusLabel status="Draft"/> |
| FR-UID-002   | User authentication     | <PriorityLabel priority="Must Have"/>   | <StatusLabel status="Draft"/> |
| FR-UID-003   | Session management      | <PriorityLabel priority="Must Have"/>   | <StatusLabel status="Draft"/> |
| FR-UID-004   | User profile management | <PriorityLabel priority="Should Have"/> | <StatusLabel status="Draft"/> |
| FR-UID-005   | Password management     | <PriorityLabel priority="Should Have"/> | <StatusLabel status="Draft"/> |
| FR-UID-006   | Account deletion        | <PriorityLabel priority="Should Have"/> | <StatusLabel status="Draft"/> |
| FR-UID-007   | Security policies       | <PriorityLabel priority="Must Have"/>   | <StatusLabel status="Draft"/> |

### FR-UID-001: User registration

**Priority:** <PriorityLabel priority="Must Have"/>

**Description:**
Users must be able to create a new account by registering with a unique username, email address, and password.
Registration creates a user identity that serves as the foundation for all personalized features across the system.

**Preconditions:**

- User must not yet be registered
- Registration endpoint must be accessible

**Postconditions:**

- New User aggregate is created
- User credentials are securely stored
- UserRegistered event is published
- User is authenticated (logged in) automatically
- Default resources are initialized (dashboard, task list, calendar, etc.)

**Business rules:**

- Username must be unique across the system
- Username must be 3–30 characters, alphanumeric plus underscore/hyphen
- Email must be valid format and unique
- Password must meet complexity requirements (min eight characters, at least one uppercase, one lowercase, one
  digit)
- Registration must be atomic (user creation and credential storage)
- User account is active immediately upon registration (no email verification in MVP)

**User roles:**

- Anonymous User (pre-registration)

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-002 (User Productivity Enhancement), BR-005 (User Value
  Delivery)
- Domain Aggregates: User (root)
- Domain Events: UserRegistered

**Dependencies:**

- None (foundational context)

**Acceptance criteria:**

- User can register with username, email, and password
- Username is validated for uniqueness
- Email is validated for format and uniqueness
- Password is validated for complexity
- User credentials are hashed before storage
- UserRegistered event is published with userId
- User is automatically logged in after registration
- Registration failures show appropriate error messages
- Duplicate username/email is rejected

**Technical notes:**

- Use bcrypt (or Argon2) for password hashing with an appropriate cost factor
- Implement rate limiting on registration endpoint to prevent abuse
- Username and email uniqueness checks should use database constraints
- Store userId as UUID or strongly typed identifier
- Ensure HTTPS for registration endpoint
- Consider implementing CAPTCHA for bot prevention (future)
- Log registration attempts for security monitoring

**Open questions:**

- Should email verification be required before account activation?
- Should there be a waiting period before the username can be reused if an account is deleted?

### FR-UID-002: User authentication

**Priority:** <PriorityLabel priority="Must Have"/>

**Description:**
Users must be able to authenticate (log in) using their registered credentials (username or email and password).
Successful authentication establishes a session that grants access to personalized features across the system.

**Preconditions:**

- User must be registered
- User account must be active (not deleted or suspended)

**Postconditions:**

- User credentials are validated
- Session is created with session token
- UserLoggedIn event is published
- User is granted access to protected resources
- Session token is returned to the client

**Business rules:**

- Users can log in with a username or an email (both accepted)
- Password must match stored hashed credential
- Failed login attempts are logged for security monitoring
- Account lockout after N failed attempts (e.g., 5) to prevent brute force
- Successful login resets the failed attempt counter
- Session token is generated using a secure random algorithm

**User roles:**

- Registered User (unauthenticated)

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-002 (User Productivity Enhancement), BR-005 (User Value
  Delivery)
- Domain Aggregates: User (root), Session
- Domain Events: UserLoggedIn

**Dependencies:**

- FR-UID-001 (User must be registered)

**Acceptance criteria:**

- User can log in with username and password
- User can log in with email and password
- Password is verified against hashed credential
- Successful login creates a session and returns a token
- UserLoggedIn event is published with userId
- Failed login shows a generic error (security best practice)
- Multiple failed attempts trigger account lockout
- Locked account shows an appropriate message
- Session token is returned in a secure HTTP-only cookie or response body

**Technical notes:**

- Use constant-time comparison for password verification to prevent timing attacks
- Implement rate limiting on login endpoint (e.g., max 10 attempts per minute per IP)
- Store session tokens securely (HTTP-only, Secure, SameSite cookies)
- Use JWT or opaque tokens for session management
- Log all login attempts (success and failure) with an IP address and timestamp
- Implement account lockout with exponential backoff (future enhancement)
- Consider implementing "Remember Me" functionality with long-lived refresh tokens (future)

**Open questions:**

- Should there be multifactor authentication (MFA) support?
- Should there be device tracking/recognition?

### FR-UID-003: Session management

**Priority:** <PriorityLabel priority="Must Have"/>

**Description:**
The system must provide a mechanism to maintain an authenticated user’s state across multiple requests.
This mechanism—referred to as a “session” conceptually—must support creation, validation, expiration, and termination.
Users may maintain multiple independent authenticated sessions (e.g., one per device or browser).

**Preconditions:**

- User has successfully authenticated.
- A new authenticated session is established following login.

**Postconditions:**

- An authenticated session is created, validated, refreshed, expired, or terminated, depending on user actions and time-based conditions.
- Expired or invalid sessions must not grant access to protected resources.
- A `UserLoggedOut` event is emitted when a session is terminated by the user.

**Business rules:**

- Sessions must expire after a configurable period of inactivity.
- Sessions must have an absolute maximum lifespan from the time of creation.
- Users may hold multiple concurrent sessions.
- Logging out terminates *only* the active session.
- The system must ensure that expired or terminated sessions cannot be used to access protected resources.

**User roles:**

- Authenticated User

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-003 (Technical Excellence), BR-005 (User Value Delivery)
- Domain Aggregates: Session, User
- Domain Events: UserLoggedIn, UserLoggedOut

**Dependencies:**

- FR-UID-002 (User must be authenticated)

**Acceptance criteria:**

- A new authenticated session is established upon successful login.
- Access to protected resources requires a valid session.
- Sessions are evaluated for validity on each request.
- Expired sessions are rejected with `401 Unauthorized`.
- User can log out, and the active session is terminated.
- A `UserLoggedOut` event is emitted upon logout.
- Multiple sessions per user are supported.
- Inactivity timeout and absolute expiration are enforced.

**Technical notes:**

- Use Redis or in-memory cache for session storage (performance)
- Implement session token as JWT (stateless) or opaque token (stateful)
- If using JWT, store refresh tokens separately for rotation
- Implement session cleanup scheduled job (e.g., cron, Spring @Scheduled)
- Use secure random for session token generation
- Store session with TTL (time-to-live) in Redis for automatic expiration
- Consider implementing session fingerprinting for security (future)

**Open questions:**

- Should there be a maximum number of concurrent sessions per user?
- Should users be able to view and revoke active sessions?

### FR-UID-004: User profile management

**Priority:** <PriorityLabel priority="Should Have"/>

**Description:**
Users should be able to view and update basic profile information including display name, email, and username. Profile
management provides users with control over their identity within the system.

**Preconditions:**

- User must be authenticated
- User must have an active session

**Postconditions:**

- User profile is updated
- Changes are persisted
- UserUpdated event is published (if needed)

**Business rules:**

- The display name is optional, length-bounded (1–100 characters)
- Email must be unique and valid format
- Username changes must maintain uniqueness
- Password changes require current password verification
- Profile changes are atomic (all or nothing)

**User roles:**

- Authenticated User

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-002 (User Productivity Enhancement), BR-005 (User Value
  Delivery)
- Domain Aggregates: User (root)
- Domain Events: UserUpdated

**Dependencies:**

- FR-UID-002 (User must be authenticated)

**Acceptance criteria:**

- Users can view current profile information
- Users can update a display name
- Users can update email (with uniqueness validation)
- Users can update username (with uniqueness validation)
- Changes are validated before saving
- Profile updates are persisted
- UserUpdated event is published
- Invalid updates show appropriate error messages

**Technical notes:**

- Implement optimistic locking for concurrent profile updates
- Email changes may require re-verification (future enhancement)
- Username changes should be logged for security audit
- Consider implementing username change cooldown (e.g., once per 30 days)
- Profile updates should use PATCH semantics (partial updates)

**Open questions:**

- Should email changes require verification of a new email?
- Should username changes be restricted or have a cooldown period?

### FR-UID-005: Password management

**Priority:** <PriorityLabel priority="Should Have"/>

**Description:**
Users should be able to change their password by providing the current password and a new password. Password changes
enhance security and allow users to update compromised credentials.

**Preconditions:**

- User must be authenticated
- User must have an active session

**Postconditions:**

- Password is changed
- New password hash is stored
- PasswordChanged event is published
- All other sessions are optionally invalidated (security best practice)

**Business rules:**

- Current password must be verified before change
- The new password must meet complexity requirements
- The new password must be different from the current password
- Password change invalidates all other sessions (optional)
- Password changes are logged for security audit

**User roles:**

- Authenticated User

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-003 (Technical Excellence), BR-005 (User Value Delivery)
- Domain Aggregates: User (root)
- Domain Events: PasswordChanged

**Dependencies:**

- FR-UID-002 (User must be authenticated)
- FR-UID-007 (Security policies)

**Acceptance criteria:**

- User can access a password change form
- Current password is required and verified
- The new password must meet complexity requirements
- The new password must be different from the current password
- Password change succeeds with valid inputs
- Password hash is updated in storage
- PasswordChanged event is published
- User is notified of a successful password change
- Other sessions are invalidated (optional)

**Technical notes:**

- Use the same password hashing algorithm as registration (bcrypt/Argon2)
- Implement password history to prevent reuse of recent passwords (future)
- Log password changes with timestamp and IP address
- Consider sending email notification of a password change
- Implement rate limiting on password change endpoint
- Current password verification should use constant-time comparison

**Open questions:**

- Should there be a password change cooldown period?
- Should password history be enforced (e.g., cannot reuse any of the last five passwords)?

### FR-UID-006: Account deletion

**Priority:** <PriorityLabel priority="Should Have"/>

**Description:**
Users should be able to delete their account permanently. Account deletion removes all user data and is irreversible.
This feature provides users with control over their data and complies with privacy regulations.

**Preconditions:**

- User must be authenticated
- User must confirm deletion intent (confirmation dialog)

**Postconditions:**

- User account is marked as deleted
- UserDeleted event is published
- All user data across contexts is deleted (cascade)
- User is logged out
- All sessions are invalidated

**Business rules:**

- Account deletion requires password confirmation
- Deletion is permanent and irreversible (hard delete in MVP)
- UserDeleted event triggers cleanup in all bounded contexts
- All user-related data is deleted (cascade)
- Deleted usernames can be registered again after a grace period (optional)
- Account deletion is logged for audit

**User roles:**

- Authenticated User

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-005 (User Value Delivery)
- Domain Aggregates: User (root)
- Domain Events: UserDeleted

**Dependencies:**

- FR-UID-002 (User must be authenticated)
- All other contexts (must handle UserDeleted event)

**Acceptance criteria:**

- User can access the account deletion option
- Deletion requires password confirmation
- Confirmation dialog warns of permanent deletion
- User account is deleted on confirmation
- UserDeleted event is published with userId
- User is logged out immediately
- All sessions are invalidated
- User cannot log in with a deleted account
- Deletion is logged for audit

**Technical notes:**

- Implement soft delete with a grace period before hard delete (future enhancement)
- Use distributed transactions or saga pattern for cross-context cleanup
- Ensure the UserDeleted event is published reliably (transactional outbox pattern)
- Log account deletions with sufficient detail for audit
- Consider implementing account deactivation as an alternative to deletion (future)
- Ensure GDPR/data privacy compliance for deletion process

**Open questions:**

- Should there be a grace period (e.g., 30 days) before permanent deletion?
- Should the deleted usernames be reserved to prevent impersonation?

### FR-UID-007: Security policies

**Priority:** <PriorityLabel priority="Must Have"/>

**Description:**
The system must enforce security policies to protect user accounts and prevent unauthorized access. Policies include
password complexity, account lockout, session security, and audit logging.

**Preconditions:**

- System is configured with security policies
- Policies are enforced on all identity operations

**Postconditions:**

- Security policies are enforced consistently
- Violations are logged and handled appropriately
- Audit trail is maintained for security events

**Business rules:**

- Password complexity: min eight characters, uppercase, lowercase, digit
- Account lockout: five failed attempts, 15-minute lockout
- Session timeout: 30-minute inactivity, 24 hours absolute
- All security events are logged (login, logout, password change, account deletion)
- Passwords are hashed using bcrypt with cost factor 12
- Session tokens are securely random (min 32 bytes entropy)

**User roles:**

- System (policy enforcement)
- Authenticated User (subject to policies)

**Related to:**

- Business Requirements: BR-001 (Portfolio Enhancement), BR-003 (Technical Excellence)
- Domain Aggregates: User (root), Session
- Domain Events: All user events

**Dependencies:**

- All other FR-UID features (policies apply system-wide)

**Acceptance criteria:**

- Password complexity is enforced on registration and password change
- Account lockout is triggered after failed login attempts
- Sessions expire, according to timeout policies
- All passwords are hashed with bcrypt
- Session tokens are cryptographically secure
- All security events are logged with context
- Audit logs are retained for compliance
- Security policies are configurable (environment variables)

**Technical notes:**

- Use Spring Security for policy enforcement
- Implement a custom password validator with configurable rules
- Use bcrypt from Spring Security Crypto (BCryptPasswordEncoder)
- Use SecureRandom for token generation
- Store audit logs in a dedicated table or logging system
- Implement policy configuration via application.properties or environment variables
- Consider implementing intrusion detection/prevention (future)

**Open questions:**

- Should security policies be user-configurable (e.g., longer session timeout)?
- Should there be notification of suspicious activity (e.g., login from a new location)?

## Cross-feature considerations

### Interactions between features

- **Registration ↔ Security Policies:** Registration enforces password complexity
- **Authentication ↔ Security Policies:** Authentication enforces lockout and logging
- **Session Management ↔ Security Policies:** Sessions enforce timeout policies
- **Password Management ↔ Security Policies:** Password changes enforce complexity
- **Account Deletion ↔ All Features:** Deletion publishes event consumed by all contexts
- **All Features ↔ Audit Logging:** All operations are logged for security

### Shared business rules

1. **Password Security:** All passwords must meet complexity requirements and be hashed
2. **Username Uniqueness:** Usernames must be unique system-wide
3. **Email Uniqueness:** Emails must be unique system-wide
4. **Session Security:** All sessions must have timeout policies enforced
5. **Audit Trail:** All security events must be logged
6. **Atomicity:** All user operations must be atomic (all or nothing)

### Data consistency requirements

- **Strong Consistency:** User registration, authentication, and deletion require strong consistency
- **Session Consistency:** Session operations require strong consistency (token validity)
- **Audit Consistency:** Audit logs must be reliably persisted (transactional)
- **Cross-Context Consistency:** UserDeleted event must reliably trigger cleanup in all contexts
- **Password Hashing:** Password hashing must be deterministic and consistent

## Business constraints impact

### BC-001: Budget

User Identity must operate within zero-cost infrastructure constraints:

- **Authentication:** Use local authentication (no paid Auth0, Okta, etc.)
- **Session Storage:** Use free-tier Redis or in-memory cache (Spring Session)
- **Database:** Use free-tier PostgreSQL for user storage
- **Audit Logging:** Use application logs (no paid logging service initially)

### BC-002: Timeline

User Identity is on a critical path for MVP (3-6 months):

- **Must Have features** (FR-UID-001, 002, 003, 007) required for MVP
- **Should Have features** (FR-UID-004, 005, 006) can be deferred to post-MVP
- Prioritize basic registration/login/session management
- Defer advanced features like profile management and account deletion

### BC-003: Resources

Single-developer constraints affect User Identity:

- **Leverage Frameworks:** Use Spring Security for authentication (avoid custom implementation)
- **Simplify Policies:** Start with basic password complexity and lockout
- **Automate Testing:** Heavy investment in security testing (password hashing, session management)
- **Incremental Development:** Build registration first, then login, then session management

### BC-004: Technology stack

User Identity aligns with the chosen stack:

- **Backend:** Spring Boot with Spring Security for authentication/authorization
- **Password Hashing:** BCryptPasswordEncoder from Spring Security
- **Session Management:** Spring Session with Redis or in-memory
- **Database:** PostgreSQL for user and audit storage
- **Events:** Spring Events initially; design for future Kafka/RabbitMQ migration
- **Testing:** JUnit, Mockito for unit tests; TestContainers for integration tests

## Success metrics alignment

User Identity contributes to the following success metrics from BR-001 through BR-008:

### BR-003: Technical metrics

| Metric                       | Target        | User Identity contribution                             |
|------------------------------|---------------|--------------------------------------------------------|
| **API Response Time**        | < 200ms (p95) | Fast authentication, session validation                |
| **Security Vulnerabilities** | Zero Critical | Proper password hashing, secure session management     |
| **Test Coverage**            | > 80%         | Comprehensive security testing for all FR-UID features |

### BR-001: Portfolio quality metrics

| Metric                         | Target             | User Identity contribution                                    |
|--------------------------------|--------------------|---------------------------------------------------------------|
| **Architecture Documentation** | All views complete | User aggregate design, authentication flow, security policies |
| **Code Quality Score**         | No critical issues | Clean authentication code, proper security practices          |

### BR-002, BR-005: User experience metrics

| Metric                   | Target            | User Identity contribution                        |
|--------------------------|-------------------|---------------------------------------------------|
| **Task Completion Rate** | > 95%             | Simple registration, reliable login, clear errors |
| **Mobile Usability**     | Fully Responsive  | Responsive login/registration forms               |
| **Accessibility Score**  | WCAG 2.1 Level AA | Accessible forms, clear error messages            |

## Traceability matrix

| Feature    | Business Req           | Domain Events                        | User Stories |
|------------|------------------------|--------------------------------------|--------------|
| FR-UID-001 | BR-001, BR-002, BR-005 | UserRegistered                       | US-UID-001-* |
| FR-UID-002 | BR-001, BR-002, BR-005 | UserLoggedIn                         | US-UID-002-* |
| FR-UID-003 | BR-001, BR-003, BR-005 | UserLoggedIn, UserLoggedOut          | US-UID-003-* |
| FR-UID-004 | BR-001, BR-002, BR-005 | UserUpdated                          | US-UID-004-* |
| FR-UID-005 | BR-001, BR-003, BR-005 | PasswordChanged                      | US-UID-005-* |
| FR-UID-006 | BR-001, BR-005         | UserDeleted                          | US-UID-006-* |
| FR-UID-007 | BR-001, BR-003         | All user events (policy enforcement) | US-UID-007-* |